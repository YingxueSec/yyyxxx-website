---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';
import ThemeToggle from '../components/ThemeToggle.astro';
import { products, updates, type ProductId } from '../data/updates';

const updateCounts = products.reduce<Record<ProductId, number>>((acc, p) => {
  acc[p.id] = updates.filter((u) => u.product === p.id).length;
  return acc;
}, {} as Record<ProductId, number>);
---

<Layout title="æ›´æ–°æ—¥å¿— - æ˜ é›ªå®‰å…¨" description="æ˜ é›ªå®‰å…¨äº§å“æ›´æ–°æ—¥å¿—ä¸å¼€å‘è¿›åº¦ï¼ˆ2025-04 è‡³ä»Šï¼‰">
  <!-- ç²¾è‡´ç½‘æ ¼èƒŒæ™¯ -->
  <div class="fixed inset-0 -z-10 grid-bg opacity-40 dark:opacity-30"></div>

  <!-- é«˜ç«¯æ¸å˜èƒŒæ™¯ - æ·±è‰²æ¨¡å¼ -->
  <div class="fixed inset-0 -z-10 overflow-hidden hidden dark:block">
    <div class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-blue-600/20 rounded-full blur-[120px]"></div>
    <div class="absolute top-1/3 right-0 w-[500px] h-[500px] bg-indigo-600/15 rounded-full blur-[100px]"></div>
    <div class="absolute bottom-0 left-1/3 w-[400px] h-[400px] bg-purple-600/10 rounded-full blur-[100px]"></div>
  </div>

  <!-- é«˜ç«¯æ¸å˜èƒŒæ™¯ - æµ…è‰²æ¨¡å¼ -->
  <div class="fixed inset-0 -z-10 overflow-hidden dark:hidden">
    <div class="absolute -top-40 -left-40 w-[600px] h-[600px] bg-blue-400/15 rounded-full blur-[120px]"></div>
    <div class="absolute top-1/3 right-0 w-[500px] h-[500px] bg-indigo-400/10 rounded-full blur-[100px]"></div>
    <div class="absolute bottom-0 left-1/3 w-[400px] h-[400px] bg-purple-400/8 rounded-full blur-[100px]"></div>
  </div>

  <Navbar currentPage="updates">
    <ThemeToggle slot="theme-toggle" />
  </Navbar>

  <!-- é¡µé¢æ ‡é¢˜ -->
  <section class="container mx-auto relative px-6 py-20">
    <div class="mx-auto flex max-w-[980px] flex-col items-center gap-6 text-center">
      <div class="fade-in-up inline-flex items-center rounded-full bg-gradient-to-r from-green-500/20 to-blue-500/20 px-4 py-2 text-sm font-medium border border-green-500/20 backdrop-blur-sm">
        <span class="mr-2 text-lg">ğŸ§©</span>
        <span class="text-green-400">äº§å“æ›´æ–°</span>
      </div>

      <h1 class="fade-in-up delay-100 text-4xl font-bold leading-tight tracking-tighter md:text-5xl lg:text-6xl">
        æ›´æ–°<span class="gradient-text-animated">æ—¥å¿—</span>
      </h1>

      <p class="fade-in-up delay-200 max-w-[820px] text-lg text-muted-foreground leading-relaxed">
        ä» <strong class="text-foreground">2025-04</strong> èµ·çš„ç‰ˆæœ¬èŠ‚å¥æ•´ç†ï¼šè¦†ç›– JackProxy / Yingxue AiSQL / SnowLight / FlowEyeã€‚
      </p>

      <div class="fade-in-up delay-300 grid w-full max-w-4xl gap-4 sm:grid-cols-2 lg:grid-cols-4">
        {products.map((p) => (
          <a href={p.href} class="group rounded-2xl border border-border/50 bg-card/40 p-4 backdrop-blur-sm hover-card hover:border-primary/30">
            <div class="flex items-center justify-between">
              <div class="font-semibold">{p.name}</div>
              <span class={`inline-flex items-center rounded-full bg-${p.badgeColor}-500/10 px-2.5 py-1 text-xs font-medium text-${p.badgeColor}-400 ring-1 ring-inset ring-${p.badgeColor}-500/20`}>
                {updateCounts[p.id]} æ¡
              </span>
            </div>
            <div class="mt-2 text-sm text-muted-foreground">æŸ¥çœ‹äº§å“è¯¦æƒ… â†’</div>
          </a>
        ))}
      </div>
    </div>
  </section>

  <!-- æ›´æ–°ç­›é€‰ -->
  <section class="container mx-auto px-6 pb-6">
    <div class="mx-auto max-w-3xl">
      <div class="flex flex-col gap-3 rounded-2xl border border-border/50 bg-card/40 p-5 backdrop-blur-sm">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div class="text-sm font-semibold">ç­›é€‰</div>
          <div class="text-xs text-muted-foreground">ç‚¹å‡»æ ‡ç­¾ç­›é€‰å¯¹åº”äº§å“</div>
        </div>
        <div class="flex flex-wrap gap-2" id="update-filters" role="tablist" aria-label="äº§å“ç­›é€‰">
          <button type="button" data-filter="all" class="filter-chip is-active" role="tab" aria-selected="true">å…¨éƒ¨</button>
          {products.map((p) => (
            <button type="button" data-filter={p.id} class="filter-chip" role="tab" aria-selected="false">
              {p.name}
            </button>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- æ—¶é—´çº¿ -->
  <section class="container mx-auto px-6 pb-24">
    <div class="mx-auto max-w-3xl">
      {updates.map((u, index) => {
        const product = products.find((p) => p.id === u.product);
        const dotColor = u.product === 'floweye' ? 'primary' : u.product === 'jackproxy' ? 'purple' : u.product === 'aisql' ? 'orange' : 'cyan';
        const borderColor = index === 0 ? 'border-primary/30' : 'border-border/30';
        return (
          <div class={`update-item relative pl-10 pb-10 border-l-2 ${borderColor}`} data-product={u.product}>
            <div class="absolute left-0 top-0 -translate-x-1/2 flex h-5 w-5 items-center justify-center">
              <div class={`h-5 w-5 rounded-full border-2 border-${dotColor} bg-${dotColor}/10 ${index === 0 ? `shadow-lg shadow-${dotColor}/30` : ''}`}></div>
            </div>

            <div class="group rounded-2xl border border-border/50 bg-card/50 p-6 backdrop-blur-sm hover-card">
              <div class="flex flex-wrap items-center gap-3 mb-4">
                <time class="text-sm text-muted-foreground bg-muted/50 px-3 py-1 rounded-full">{u.date}</time>
                <span class="inline-flex items-center rounded-full bg-green-500/10 px-3 py-1 text-xs font-medium text-green-400 ring-1 ring-inset ring-green-500/20">
                  {u.version}
                </span>
                {product && (
                  <a href={product.href} class={`inline-flex items-center rounded-full bg-${product.badgeColor}-500/10 px-3 py-1 text-xs font-medium text-${product.badgeColor}-400 ring-1 ring-inset ring-${product.badgeColor}-500/20 hover:underline`}>
                    {product.name}
                  </a>
                )}
              </div>

              <h3 class="text-xl font-bold mb-4 group-hover:text-primary transition-colors">{u.title}</h3>

              <div class="space-y-4 text-muted-foreground">
                <div class="p-4 rounded-xl bg-card/50 border border-border/30">
                  <p class="font-semibold text-foreground/80 mb-2">æ›´æ–°è¦ç‚¹</p>
                  <ul class="space-y-1.5 ml-4 text-sm">
                    {u.highlights.map((item) => (
                      <li class="flex items-start gap-2">
                        <span class="text-blue-400">â€¢</span>
                        <span>{item}</span>
                      </li>
                    ))}
                  </ul>
                </div>

                {u.sections && u.sections.length > 0 && (
                  <details class="rounded-xl border border-border/30 bg-muted/20 p-4">
                    <summary class="cursor-pointer select-none text-sm font-semibold text-foreground/80">
                      å±•å¼€è¯¦ç»†å†…å®¹
                    </summary>
                    <div class="mt-4 space-y-3 text-sm text-muted-foreground">
                      {u.sections.map((s) => (
                        <div class="rounded-lg bg-card/40 border border-border/30 p-3">
                          <div class="font-semibold text-foreground/80 mb-2">{s.title}</div>
                          <ul class="space-y-1.5 ml-4">
                            {s.items.map((it) => (
                              <li class="flex items-start gap-2">
                                <span class="text-emerald-400">â€¢</span>
                                <span>{it}</span>
                              </li>
                            ))}
                          </ul>
                        </div>
                      ))}
                    </div>
                  </details>
                )}
              </div>

              {u.links && u.links.length > 0 && (
                <div class="flex flex-wrap gap-3 pt-4 mt-4 border-t border-border/30">
                  {u.links.map((l) => (
                    <a
                      href={l.href}
                      target={('external' in l && l.external) ? '_blank' : undefined}
                      class="text-sm text-primary hover:underline"
                    >
                      {l.label} â†’
                    </a>
                  ))}
                </div>
              )}
            </div>
          </div>
        );
      })}

      <div class="relative pl-10">
        <div class="absolute left-0 top-0 -translate-x-1/2 flex h-5 w-5 items-center justify-center">
          <div class="h-5 w-5 rounded-full border-2 border-border bg-muted"></div>
        </div>
        <p class="text-sm text-muted-foreground italic">æ›´å¤šæ›´æ–°æŒç»­è¿­ä»£ä¸­â€¦</p>
      </div>
    </div>
  </section>

  <!-- æœåŠ¡è¯´æ˜ï¼ˆä¸å†™ç‰ˆæœ¬æ—¥å¿—ï¼‰ -->
  <section class="container mx-auto px-6 pb-24">
    <div class="mx-auto max-w-3xl">
      <div class="rounded-2xl border border-border/50 bg-card/40 p-6 backdrop-blur-sm">
        <div class="flex items-center justify-between gap-4 flex-wrap">
          <div class="space-y-1">
            <div class="text-sm font-semibold text-primary tracking-wide uppercase">æœåŠ¡</div>
            <h2 class="text-2xl font-bold">ä¸“ä¸šå…æ€æœåŠ¡</h2>
          </div>
          <a href="/products/antivirus" class="text-sm text-primary hover:underline">æŸ¥çœ‹æœåŠ¡ä»‹ç» â†’</a>
        </div>
        <p class="mt-4 text-muted-foreground leading-relaxed">
          ç›®å‰ä»å¯å¯¹æŠ—å›½å†…å¤–ä¸»æµå®‰å…¨è½¯ä»¶ï¼Œå¹¶æä¾›è‡ªåŠ¨åŒ–ç»´æƒæµç¨‹æ”¯æŒï¼ˆéœ€åœ¨<strong class="text-foreground">åˆæ³•æˆæƒ</strong>å‰æä¸‹æ‰§è¡Œï¼‰ã€‚å¦‚éœ€æŠ¥ä»·/æ–¹æ¡ˆ/æµ‹è¯•ï¼Œè¯·ç›´æ¥è”ç³»ã€‚
        </p>
        <div class="mt-5 flex flex-wrap items-center gap-3">
          <a href="/#contact" class="inline-flex h-10 items-center justify-center rounded-lg bg-primary px-6 text-sm font-medium text-primary-foreground transition-colors hover:bg-primary/90">
            è”ç³»æˆ‘ä»¬
          </a>
          <a href="/products/antivirus" class="inline-flex h-10 items-center justify-center rounded-lg border border-border bg-background px-6 text-sm font-medium transition-colors hover:bg-accent">
            æŸ¥çœ‹è¯¦æƒ…
          </a>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="border-t border-border/40 bg-card/30 backdrop-blur-sm">
    <div class="container mx-auto px-6 py-8">
      <div class="flex flex-col md:flex-row items-center justify-between gap-6">
        <div class="flex flex-col items-center md:items-start gap-2">
          <div class="flex items-center gap-2">
            <img src="/logo.png" alt="æ˜ é›ªå®‰å…¨" class="h-6 w-6 opacity-70" />
            <span class="text-sm font-medium text-foreground/70">æ˜ é›ªå®‰å…¨</span>
          </div>
          <p class="text-xs text-muted-foreground">Â© 2025 YingxueSec. All rights reserved.</p>
        </div>

        <div class="flex flex-wrap items-center justify-center gap-4 text-xs">
          <a
            href="https://www.52jl.top"
            target="_blank"
            rel="noopener noreferrer"
            class="px-3 py-1.5 rounded-full bg-muted/50 border border-border/30 text-muted-foreground hover:text-foreground transition-colors"
          >
            å‹æƒ…é“¾æ¥ï¼š52jl
          </a>
          <div class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-muted/50 border border-border/30">
            <svg class="h-3.5 w-3.5 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            <span class="text-muted-foreground">è¿è¡Œ <span id="runtime_days" class="text-foreground/80 font-medium">0</span> å¤©</span>
          </div>
        </div>
      </div>
    </div>
  </footer>
</Layout>

<style>
  .filter-chip {
    border: 1px solid hsl(var(--border));
    background: hsl(var(--background));
    color: hsl(var(--muted-foreground));
    padding: 0.5rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.875rem;
    line-height: 1;
    transition: all 150ms ease;
  }
  .filter-chip:hover {
    background: hsl(var(--accent));
    color: hsl(var(--foreground));
  }
  .filter-chip.is-active {
    background: hsl(var(--primary));
    border-color: hsl(var(--primary));
    color: hsl(var(--primary-foreground));
  }
  .update-item.is-hidden {
    display: none;
  }
</style>

<script is:inline>
  (function () {
    const filters = document.getElementById('update-filters');
    if (!filters) return;

    const items = Array.from(document.querySelectorAll('.update-item'));
    const buttons = Array.from(filters.querySelectorAll('button[data-filter]'));

    function setActive(filter) {
      buttons.forEach((btn) => {
        const isActive = btn.getAttribute('data-filter') === filter;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });

      items.forEach((el) => {
        const product = el.getAttribute('data-product');
        const shouldShow = filter === 'all' || product === filter;
        el.classList.toggle('is-hidden', !shouldShow);
      });
    }

    filters.addEventListener('click', function (e) {
      const target = e.target;
      if (!(target instanceof HTMLElement)) return;
      const btn = target.closest('button[data-filter]');
      if (!btn) return;
      setActive(btn.getAttribute('data-filter'));
    });

    setActive('all');
  })();
</script>

<script is:inline>
  // è®¡ç®—è¿è¡Œæ—¶é—´ï¼ˆä» 2025-11-20 å¼€å§‹ï¼‰ï¼ŒæŒ‰åŒ—äº¬æ—¶é—´ï¼ˆUTC+8ï¼‰è®¡ç®—â€œå¤©æ•°â€
  function updateRuntime() {
    const BJ_OFFSET_MS = 8 * 60 * 60 * 1000;
    const MS_PER_DAY = 24 * 60 * 60 * 1000;
    const START_DAY_INDEX = Math.floor(Date.UTC(2025, 10, 20) / MS_PER_DAY);
    const nowDayIndex = Math.floor((Date.now() + BJ_OFFSET_MS) / MS_PER_DAY);
    const days = Math.max(0, nowDayIndex - START_DAY_INDEX);
    const runtimeElement = document.getElementById('runtime_days');
    if (runtimeElement) runtimeElement.textContent = String(days);
  }
  updateRuntime();
  (function scheduleRuntimeUpdateAtBJMidnight() {
    const BJ_OFFSET_MS = 8 * 60 * 60 * 1000;
    const MS_PER_DAY = 24 * 60 * 60 * 1000;
    const nowShifted = Date.now() + BJ_OFFSET_MS;
    const msUntilNextBJMidnight = MS_PER_DAY - (nowShifted % MS_PER_DAY);
    setTimeout(() => {
      updateRuntime();
      setInterval(updateRuntime, MS_PER_DAY);
    }, msUntilNextBJMidnight);
  })();
</script>
